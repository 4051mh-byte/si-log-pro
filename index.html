<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SI Log Pro (AI Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap');
        
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #cbd5e1;
            font-size: 13px;
            height: 100vh;
            overflow: hidden;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        
        .paper-sheet {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #94a3b8;
            margin-bottom: 2rem;
        }

        .sketch-input {
            border: 2px solid #475569;
            border-radius: 0.25rem;
            padding: 0.4rem;
            background-color: #fff;
            font-size: 0.9rem;
            color: #334155;
        }
        .sketch-input:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 1px #2563eb;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: start;
            gap: 0.3rem;
            margin-bottom: 0.2rem;
            cursor: pointer;
        }
        .checkbox-wrapper input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            border: 1.5px solid #475569;
            border-radius: 0.15rem;
            margin-top: 0.15rem;
            accent-color: #2563eb;
            flex-shrink: 0;
        }
        .checkbox-wrapper span { color: #334155; line-height: 1.2; }
        .checkbox-wrapper.checked span {
            font-weight: 700;
            color: #1e40af;
            text-decoration: underline;
            text-decoration-thickness: 1px;
        }

        .highlighter-header {
            font-weight: 800;
            font-size: 1.1rem;
            padding: 0.3rem 0.8rem;
            margin-bottom: 0.8rem;
            border-radius: 0.4rem;
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-A { background-color: #f1f5f9; color: #334155; }
        .header-B { background-color: #dbeafe; color: #1e40af; }
        .header-C { background-color: #e0e7ff; color: #3730a3; }
        .header-D { background-color: #dcfce7; color: #166534; }
        .header-E { background-color: #ffedd5; color: #9a3412; }

        .sub-col-title {
            font-size: 0.85rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #94a3b8;
            padding-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .col-c1 { color: #2563eb; border-color: #2563eb; }
        .col-c2 { color: #16a34a; border-color: #16a34a; }
        .col-c3 { color: #ea580c; border-color: #ea580c; }
        .col-c4 { color: #9333ea; border-color: #9333ea; }
        
        .scroll-bottom-spacer {
            height: 400px;
            min-height: 400px;
            flex-shrink: 0;
            pointer-events: none;
        }
        
        @media (max-width: 1024px) {
            .scroll-bottom-spacer {
                height: 300px;
                min-height: 300px;
            }
        }
    </style>
</head>
<body class="flex flex-col h-[100dvh] overflow-hidden">

    <header class="bg-slate-800 text-white px-4 py-2 shadow-md shrink-0 flex justify-between items-center z-20">
        <div class="flex items-center gap-2">
            <span class="text-xl">ğŸ“‹</span>
            <div>
                <h1 class="text-lg font-bold leading-none">SI Log Pro</h1>
                <span class="text-[10px] text-slate-300">AI Edition (Secure)</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="switchTab('write')" id="btn-tab-write" class="px-3 py-1 rounded bg-blue-600 text-xs font-bold hover:bg-blue-500 transition">ì‘ì„±</button>
            <button onclick="switchTab('history')" id="btn-tab-history" class="px-3 py-1 rounded bg-slate-600 text-xs text-slate-200 font-bold hover:bg-slate-500 transition">ê¸°ë¡ ê´€ë¦¬</button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        
        <div id="tab-write" class="flex-1 flex flex-col lg:flex-row h-full w-full">
            
            <div class="flex-1 overflow-y-auto custom-scrollbar bg-slate-200 p-4 lg:p-6 flex justify-center">
                <div class="paper-sheet w-full max-w-[1200px] min-h-max p-6 lg:p-8 flex flex-col gap-5">
                    
                    <h2 class="text-3xl font-black text-slate-800 mb-2" style="font-family: 'Nanum Pen Script', cursive; font-size: 2.8rem;">
                        Sensory Integration Log
                    </h2>

                    <section>
                        <div class="highlighter-header header-A">
                            <span>A. ì•„ë™ ê¸°ë³¸ ì •ë³´</span>
                            <button onclick="resetApp()" class="text-[11px] bg-white border px-2 py-0.5 rounded text-slate-500 hover:bg-red-50 hover:text-red-500 transition">ì´ˆê¸°í™” â†º</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-2">
                            <div class="md:col-span-3">
                                <label class="block text-xs font-bold text-slate-600">ì´ë¦„</label>
                                <input type="text" id="input-name" class="sketch-input w-full" placeholder="ì´ë¦„" oninput="handleNameInput()">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-bold text-slate-600">ìƒë…„ì›”ì¼</label>
                                <div class="flex gap-1">
                                    <input type="date" id="input-dob" class="sketch-input w-full" oninput="updateBasicInfo()">
                                    <button onclick="resetDob()" class="bg-slate-200 px-2 rounded text-slate-500 text-xs">â†º</button>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-slate-600">ìƒí™œì—°ë ¹</label>
                                <div id="display-age" class="sketch-input w-full bg-slate-50 text-center font-bold text-indigo-700 flex items-center justify-center">-</div>
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-xs font-bold text-slate-600">ì¹˜ë£Œ ë‚ ì§œ / íšŒì°¨</label>
                                <div class="relative">
                                    <input type="date" id="input-date" class="sketch-input w-full" oninput="updateBasicInfo()">
                                    <span id="session-count-badge" class="absolute right-2 top-2 bg-yellow-100 text-yellow-800 text-[10px] font-bold px-1.5 rounded hidden"></span>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-slate-600">ì»¨ë””ì…˜</label>
                                <select id="input-condition" class="sketch-input w-full" onchange="generateReport()">
                                    <option value="">ì„ íƒ</option>
                                    <option value="ì–‘í˜¸ (Good)">ì–‘í˜¸ (Good)</option>
                                    <option value="í”¼ê³¤í•¨/ì¡¸ë¦¼">í”¼ê³¤í•¨/ì¡¸ë¦¼</option>
                                    <option value="ìˆ˜ë©´ ë¶€ì¡±">ìˆ˜ë©´ ë¶€ì¡±</option>
                                    <option value="í¥ë¶„/ê³¼ê°ì„±">í¥ë¶„/ê³¼ê°ì„±</option>
                                    <option value="ë¶ˆì•ˆ/ê¸´ì¥">ë¶ˆì•ˆ/ê¸´ì¥</option>
                                    <option value="ê¸°ë¶„ ì €ì¡°">ê¸°ë¶„ ì €ì¡°</option>
                                    <option value="ì»¨ë””ì…˜ ì €í•˜(ê°ê¸° ë“±)">ì»¨ë””ì…˜ ì €í•˜</option>
                                </select>
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-xs font-bold text-slate-600">ì§„ë‹¨ëª…</label>
                                <select id="select-diagnosis" onchange="handleDiagnosisSelect()" class="sketch-input w-full bg-white text-xs">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                                <input type="text" id="input-diagnosis-manual" class="sketch-input w-full mt-1 hidden" placeholder="ì§ì ‘ ì…ë ¥" oninput="updateBasicInfo()">
                            </div>
                            <div class="md:col-span-6">
                                <label class="block text-xs font-bold text-slate-600">ë©”ëª¨ (íŠ¹ì´ì‚¬í•­)</label>
                                <input type="text" id="input-memo" class="sketch-input w-full" placeholder="ì•½ë³µìš©, ë³´í˜¸ì ìš”ì²­ì‚¬í•­ ë“±" oninput="generateReport()">
                            </div>
                        </div>
                        <div id="diagnosis-tip" class="hidden text-xs text-blue-600 bg-blue-50 p-2 mt-2 rounded border border-blue-100"></div>
                    </section>

                    <section>
                        <div class="highlighter-header header-B">B. ì£¼ìš” ëª©í‘œ (Main Goals)</div>
                        <div id="container-B" class="grid grid-cols-2 md:grid-cols-5 gap-2"></div>
                    </section>

                    <section>
                        <div class="highlighter-header header-C">C. ë„êµ¬ ë° í™œë™ (Tools & Activities)</div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 border-b-2 border-dashed border-slate-300 pb-4 mb-4">
                            <div class="md:col-span-2">
                                <div class="sub-col-title col-c1">C-1. Sensory & Dynamic</div>
                                <div id="container-C1" class="grid grid-cols-2 gap-x-2"></div>
                            </div>
                            <div class="md:col-span-1">
                                <div class="sub-col-title col-c2">C-2. Posture & Core</div>
                                <div id="container-C2"></div>
                            </div>
                            <div class="md:col-span-1">
                                <div class="sub-col-title col-c3">C-3. Balance</div>
                                <div id="container-C3"></div>
                            </div>
                            <div class="md:col-span-1">
                                <div class="sub-col-title col-c4">C-4. Coordination</div>
                                <div id="container-C4"></div>
                            </div>
                        </div>

                        <div>
                            <div class="sub-col-title text-slate-600 border-slate-400">C-5. í™œë™ êµ¬ì„± (Activities)</div>
                            <div id="container-C5" class="grid grid-cols-1 md:grid-cols-4 gap-3"></div>
                        </div>
                    </section>

                    <section>
                        <div class="highlighter-header header-D">D. ì•„ë™ ë°˜ì‘ ê´€ì°° (Response)</div>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div><div class="sub-col-title text-green-700 border-green-300">D-1. ê°ê° ë°˜ì‘</div><div id="container-D1"></div></div>
                            <div><div class="sub-col-title text-green-700 border-green-300">D-2. ìš´ë™ ìˆ˜í–‰</div><div id="container-D2"></div></div>
                            <div><div class="sub-col-title text-green-700 border-green-300">D-3. í–‰ë™ ì¡°ì ˆ</div><div id="container-D3"></div></div>
                            <div><div class="sub-col-title text-green-700 border-green-300">D-4. ì •ì„œ ë°˜ì‘</div><div id="container-D4"></div></div>
                            <div><div class="sub-col-title text-green-700 border-green-300">D-5. ì‚¬íšŒì  ë°˜ì‘</div><div id="container-D5"></div></div>
                        </div>
                    </section>

                    <section>
                        <div class="highlighter-header header-E">E. ì¤‘ì¬ ì „ëµ (Intervention)</div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div><div class="sub-col-title text-orange-700 border-orange-300">E-1. í™˜ê²½ ì¡°ì ˆ</div><div id="container-E1"></div></div>
                            <div><div class="sub-col-title text-orange-700 border-orange-300">E-2. ì´‰ì§„ ê¸°ë²•</div><div id="container-E2"></div></div>
                            <div><div class="sub-col-title text-orange-700 border-orange-300">E-3. í–‰ë™ ê´€ë¦¬</div><div id="container-E3"></div></div>
                            <div><div class="sub-col-title text-orange-700 border-orange-300">E-4. ê³¼ì œ/ì¼ë°˜</div><div id="container-E4"></div></div>
                        </div>
                    </section>
                    
                    <div class="scroll-bottom-spacer"></div>
                </div>
            </div>

            <div class="w-full lg:w-[420px] bg-white border-l border-slate-300 flex flex-col shadow-xl z-10 shrink-0">
                <div class="bg-slate-100 p-3 border-b border-slate-200 flex justify-between items-center">
                    <span class="font-bold text-slate-700">ğŸ“ ì¼ì§€ ë¯¸ë¦¬ë³´ê¸°</span>
                    <div class="flex gap-1">
                        <button onclick="saveLog()" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 shadow-sm active:scale-95 transition-transform">ì €ì¥</button>
                        <button onclick="sendToGoogleDocs()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 shadow-sm active:scale-95 transition-transform">Docs</button>
                        <button onclick="copyReport()" class="bg-white border border-slate-300 text-slate-700 px-3 py-1 rounded text-xs hover:bg-slate-50 shadow-sm active:scale-95 transition-transform">ë³µì‚¬</button>
                    </div>
                </div>
                
                <textarea id="report-output" class="flex-1 p-5 resize-none focus:outline-none font-mono text-sm leading-relaxed text-slate-800 bg-white" readonly></textarea>

                <!-- â­ AI ìš”ì•½ ì˜ì—­ (API í‚¤ ì…ë ¥ë€ ì œê±°) -->
                <div class="p-4 border-t border-slate-200 bg-slate-50">
                    
                    <div class="flex flex-col gap-3 mb-3">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-slate-700 text-xs flex items-center gap-1">
                                <span class="text-blue-500 text-base">âœ¨</span> Gemini AI ì„ìƒ ë¶„ì„
                            </span>
                            <button onclick="generateGeminiSummary()" id="btn-ai" class="bg-indigo-600 text-white px-4 py-1.5 rounded-full text-xs font-bold hover:bg-indigo-700 shadow-md transition-all active:scale-95 flex items-center gap-1">
                                ğŸš€ ë¶„ì„ ì‹œì‘
                            </button>
                        </div>

                        <!-- ëª¨ë“œ ì„ íƒ -->
                        <div class="flex bg-slate-200 p-1 rounded-lg">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="ai-mode" value="fast" class="peer hidden" checked>
                                <div class="text-center text-[11px] py-1.5 rounded-md text-slate-500 font-bold transition-all peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm">
                                    âš¡ ë¹ ë¥¸
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="ai-mode" value="thinking" class="peer hidden">
                                <div class="text-center text-[11px] py-1.5 rounded-md text-slate-500 font-bold transition-all peer-checked:bg-white peer-checked:text-purple-600 peer-checked:shadow-sm">
                                    ğŸ§  ì‚¬ê³ 
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="ai-mode" value="pro" class="peer hidden">
                                <div class="text-center text-[11px] py-1.5 rounded-md text-slate-500 font-bold transition-all peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm">
                                    ğŸ’ Pro
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- AI ì¶œë ¥ ì˜ì—­ -->
                    <div class="relative group">
                        <textarea id="ai-output" class="w-full h-40 p-3 text-xs border border-slate-300 rounded-lg bg-white resize-none focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 leading-relaxed transition-colors" placeholder="ëª¨ë“œë¥¼ ì„ íƒí•˜ê³  [ë¶„ì„ ì‹œì‘]ì„ í´ë¦­í•˜ì„¸ìš”" readonly></textarea>
                        
                        <!-- ë¡œë”© í‘œì‹œ -->
                        <div id="ai-loading" class="hidden absolute inset-0 bg-white/90 backdrop-blur-[1px] flex flex-col items-center justify-center z-10 rounded-lg">
                            <div class="w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-3"></div>
                            <span id="loading-text" class="text-xs text-indigo-700 font-bold animate-pulse">Geminiê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-history" class="hidden w-full h-full bg-slate-100 p-6 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">ğŸ—‚ ì €ì¥ëœ ê¸°ë¡ ê´€ë¦¬</h2>
                    <button onclick="exportData()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 flex items-center gap-2 text-sm font-bold transition">
                        ì—‘ì…€(CSV) ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
                <div id="history-list" class="grid gap-4"></div>
                <div id="empty-history" class="hidden text-center text-slate-400 py-10">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                
                <div class="scroll-bottom-spacer"></div>
            </div>
        </div>

    </main>

    <script>
        const DIAGNOSIS_LIST = [
            { value: 'ìíìŠ¤í™íŠ¸ëŸ¼ì¥ì• ', label: 'ìíìŠ¤í™íŠ¸ëŸ¼ì¥ì•  (ASD)', keywords: 'êµ¬ì¡°í™”ëœ í™˜ê²½ ì œê³µ, ê°ê° ì¡°ì ˆ ì§€ì›' },
            { value: 'ADHD', label: 'ADHD', keywords: 'ê°ì„± ì¡°ì ˆì„ ìœ„í•œ ê³ ê°•ë„ ì…ë ¥, ì‹œê°ì  ë‹¨ì„œ ì œê³µ' },
            { value: 'ë°œë‹¬ì§€ì—°', label: 'ë°œë‹¬ì§€ì—°(GDD)', keywords: 'ë°œë‹¬ ë‹¨ê³„ì— ë§ëŠ” ë‹¨ê³„ì  ê³¼ì œ ì œì‹œ' },
            { value: 'ì§€ì ì¥ì• ', label: 'ì§€ì ì¥ì•  (ID)', keywords: 'ë‹¨ìˆœí•˜ê³  ë°˜ë³µì ì¸ ì§€ì‹œ, ì„±ê³µ ê²½í—˜ ì œê³µ' },
            { value: 'ë‡Œì„±ë§ˆë¹„', label: 'ë‡Œì„±ë§ˆë¹„ (CP)', keywords: 'ìì„¸ ì•ˆì •ì„± í™•ë³´, ë¹„ì •ìƒì  ë°˜ì‚¬ ì–µì œ' },
            { value: 'ë‹¤ìš´ì¦í›„êµ°', label: 'ë‹¤ìš´ì¦í›„êµ°', keywords: 'ê´€ì ˆ ì•ˆì •ì„± ìœ ì˜, ê³ ìœ ìˆ˜ìš©ì„± ì…ë ¥ ê°•í™”' },
            { value: 'ë°œë‹¬í˜‘ì‘ì¥ì• ', label: 'ë°œë‹¬í˜‘ì‘ì¥ì•  (DCD)', keywords: 'ìš´ë™ ê³„íš ê³¼ì • ì¤‘ì‹¬ ì¤‘ì¬, ì‹œê° ë³´ì¡°' },
            { value: 'ì–¸ì–´ë°œë‹¬ì§€ì—°', label: 'ì–¸ì–´ë°œë‹¬ì§€ì—°', keywords: 'ë¹„ì–¸ì–´ì  ì†Œí†µ ê²©ë ¤, ê°ê° ë†€ì´ í™œìš©' },
            { value: 'ì •ì„œ-í–‰ë™ë¬¸ì œ', label: 'ì •ì„œ-í–‰ë™ë¬¸ì œ', keywords: 'ì •ì„œì  ì•ˆì •ê° í˜•ì„±, ê°ê° íœ´ì‹ ì œê³µ' },
        ];

        const CATEGORIES = {
            B: {
                items: [
                    { id: 'b_vestibular', label: 'ì „ì •ê°ê°ì¡°ì ˆ' }, { id: 'b_proprioception', label: 'ê³ ìœ ìˆ˜ìš©ì„±' },
                    { id: 'b_posture', label: 'ìì„¸ì¡°ì ˆ' }, { id: 'b_praxis', label: 'ìš´ë™ê³„íš' },
                    { id: 'b_coordination', label: 'í˜‘ì‘ëŠ¥ë ¥' }, { id: 'b_attention', label: 'ì£¼ì˜ì§‘ì¤‘' },
                    { id: 'b_stability', label: 'ì²´ê°„ì•ˆì •ì„±' }, { id: 'b_balance', label: 'ê· í˜•ë°˜ì‘' },
                    { id: 'b_midline', label: 'ì •ì¤‘ì„ êµì°¨' }, { id: 'b_visuomotor', label: 'ì‹œê°ìš´ë™' },
                    { id: 'b_modulation', label: 'ê°ê°ì¡°ì ˆ' }, { id: 'b_emotion', label: 'ì •ì„œì¡°ì ˆ' },
                    { id: 'b_persistence', label: 'ê³¼ì œì§€ì†ì„±' }, { id: 'b_social', label: 'ì‚¬íšŒì ìƒí˜¸ì‘ìš©' },
                ]
            },
            C: {
                sections: [
                    { id: 'C1', items: [
                        { id: 'c1_platform', label: 'í”Œë«í¼ ê·¸ë„¤', text: 'í”Œë«í¼ ê·¸ë„¤' }, { id: 'c1_disc-swing', label: 'ì›ë°˜ ê·¸ë„¤', text: 'ì›ë°˜ ê·¸ë„¤' },
                        { id: 'c1_t_swing', label: 'Tí˜• ê·¸ë„¤', text: 'Tí˜• ê·¸ë„¤' }, { id: 'c1_bolster', label: 'ë³¼ìŠ¤í„° ê·¸ë„¤', text: 'ë³¼ìŠ¤í„° ê·¸ë„¤' },
                        { id: 'c1_ladder_swing', label: 'ì‚¬ë‹¤ë¦¬ ê·¸ë„¤', text: 'ì‚¬ë‹¤ë¦¬ ê·¸ë„¤' }, { id: 'c1_net', label: 'ë„¤íŠ¸ ê·¸ë„¤', text: 'ë„¤íŠ¸ ê·¸ë„¤' },
                        { id: 'c1_hammock', label: 'í•´ë¨¹', text: 'í•´ë¨¹' }, { id: 'c1_frog', label: 'í”„ë¡œê·¸ ê·¸ë„¤', text: 'í”„ë¡œê·¸ ê·¸ë„¤' },
                        { id: 'c1_Slide', label: 'ë¯¸ë„ëŸ¼í‹€', text: 'ë¯¸ë„ëŸ¼í‹€' }, { id: 'c1_Sliding-sit', label: 'ë¯¸ë„ëŸ¼í‹€(ì•‰ì•„)', text: 'ë¯¸ë„ëŸ¼í‹€ ì•‰ì•„ì„œ' },
                        { id: 'c1_Sliding-prone', label: 'ë¯¸ë„ëŸ¼í‹€(ì—ë“œë ¤)', text: 'ë¯¸ë„ëŸ¼í‹€ ì—ë“œë ¤' }, { id: 'c1_Sliding-back', label: 'ë¯¸ë„ëŸ¼í‹€(ë’¤ë¡œ)', text: 'ë¯¸ë„ëŸ¼í‹€ ë’¤ë¡œ' },
                        { id: 'c1_Roll', label: 'ì•êµ¬ë¥´ê¸°', text: 'ì•êµ¬ë¥´ê¸°' }, { id: 'c1_Log-roll', label: 'ë§¤íŠ¸ íšŒì „', text: 'ë§¤íŠ¸ íšŒì „ ì´ë™' },
                        { id: 'c1_Hopper', label: 'í˜¸í•‘ë³¼', text: 'í˜¸í•‘ë³¼' }, { id: 'c1_Scooter', label: 'ìŠ¤ì¿ í„°ë³´ë“œ', text: 'ìŠ¤ì¿ í„°ë³´ë“œ' },
                        { id: 'c1_Jump', label: 'ë§¤íŠ¸ ì í”„', text: 'ë§¤íŠ¸ ì í”„ ì°©ì§€' },
                    ]},
                    { id: 'C2', items: [
                        { id: 'c2_ladder', label: 'ì‚¬ë‹¤ë¦¬', text: 'ì‚¬ë‹¤ë¦¬' }, { id: 'c2_igym_top', label: 'ì•„ì´ì§ ì›í†µ', text: 'ì•„ì´ì§ ì›í†µ' },
                        { id: 'c2_igym_bar', label: 'ì•„ì´ì§ ëœ€', text: 'ì•„ì´ì§ ëœ€' }, { id: 'c2_Incline-crawl', label: 'ê²½ì‚¬ë©´ ê¸°ì–´ì˜¤ë¥´ê¸°', text: 'ê²½ì‚¬ë©´ ê¸°ì–´ì˜¤ë¥´ê¸°' },
                        { id: 'c2_wall-climb', label: 'ì•”ë²½', text: 'ì•”ë²½' }, { id: 'c2_Wheelbarrow', label: 'ì†ìˆ˜ë ˆ ìì„¸', text: 'ì†ìˆ˜ë ˆ ìì„¸' },
                        { id: 'c2_Bear-walk', label: 'ê³°ê±¸ìŒ(ë„¤ë°œê¸°ê¸°)', text: 'ê³°ê±¸ìŒ' }, { id: 'c2_Prone', label: 'ì—ë“œë¦° ìì„¸', text: 'ì—ë“œë¦° ìì„¸ ìœ ì§€' },
                        { id: 'c2_Climbing', label: 'ë¯¸ë„ëŸ¼í‹€ ì˜¤ë¥´ê¸°', text: 'ë¯¸ë„ëŸ¼í‹€ ì˜¤ë¥´ê¸°' }, { id: 'c2_Gymball', label: 'ì§ë³¼', text: 'ì§ë³¼' },
                    ]},
                    { id: 'C3', items: [
                        { id: 'c3_Unipedal', label: 'í•œë°œ ì„œê¸°', text: 'í•œë°œ ì„œê¸°' }, { id: 'c3_Dynamic-balance', label: 'ì´ë™ í›„ í•œë°œ ì„œê¸°', text: 'ì´ë™ í›„ í•œë°œ ì„œê¸°' },
                        { id: 'c3_Beam', label: 'í‰ê· ëŒ€', text: 'í‰ê· ëŒ€' }, { id: 'c3_Stepping-stones', label: 'ì§•ê²€ë‹¤ë¦¬', text: 'ì§•ê²€ë‹¤ë¦¬' },
                        { id: 'c3_Balance-board', label: 'ê· í˜•íŒ', text: 'ê· í˜•íŒ' }, { id: 'c3_Pedalo', label: 'í˜ë‹¬ë¡œ', text: 'í˜ë‹¬ë¡œ' },
                        { id: 'c3_Half-roll', label: 'ë°˜ì›ë§¤íŠ¸', text: 'ë°˜ì›ë§¤íŠ¸' },
                    ]},
                    { id: 'C4', items: [
                        { id: 'c4_Bouncing', label: 'ê³µ íŠ€ê¸°ë©° ì¡ê¸°', text: 'ê³µ íŠ€ê¸°ë©° ì¡ê¸°' }, { id: 'c4_Bowling', label: 'ë³¼ë§í•€', text: 'ë³¼ë§í•€' },
                        { id: 'c4_Spot-marker', label: 'ì›ë§ˆì»¤', text: 'ì›ë§ˆì»¤' }, { id: 'c4_Elastic', label: 'ê³ ë¬´ì¤„', text: 'ê³ ë¬´ì¤„' },
                        { id: 'c4_Rope', label: 'ë¡œí”„', text: 'ë¡œí”„' }, { id: 'c4_Hoop', label: 'í›Œë¼í›„í”„', text: 'í›Œë¼í›„í”„' },
                        { id: 'c4_Cross-crawl', label: 'êµì°¨ ê¸°ì–´ê°€ê¸°', text: 'êµì°¨ íŒ¨í„´ ê¸°ì–´ê°€ê¸°' }, { id: 'c4_Rhythm', label: 'ë¦¬ë“¬ ë™ì‘', text: 'ë¦¬ë“¬ ë”°ë¼ ë™ì‘' },
                        { id: 'c4_Cooperation', label: 'ì–‘ì† ë§‰ëŒ€', text: 'ì–‘ì† ë§‰ëŒ€ ì´ë™' },
                    ]},
                    { id: 'C5', items: [
                        { id: 'act_hang_swing', label: 'ë§¤ë‹¬ë ¤ ê·¸ë„¤ íƒ€ê¸°', text: 'ë§¤ë‹¬ë ¤ ê·¸ë„¤ íƒ€ê¸°' }, { id: 'act_pull_climb', label: 'ìˆ˜ì§ ê¸°êµ¬ ì˜¤ë¥´ê¸°', text: 'ìˆ˜ì§ ê¸°êµ¬ ì˜¤ë¥´ê¸°' },
                        { id: 'act_rope_pull', label: 'ë¡œí”„ ë‹¹ê¸°ê¸°/ë§¤ë‹¬ë¦¬ê¸°', text: 'ë¡œí”„ ë‹¹ê¸°ê¸°/ë§¤ë‹¬ë¦¬ê¸°' }, { id: 'act_posture_swing', label: 'ìì„¸ ì¡ê³  í”ë“¤ê¸°', text: 'ìì„¸ ì¡ê³  í”ë“¤ê¸°' },
                        { id: 'act_prone_ext', label: 'ì—ë“œë ¤ ìì„¸ ë²„í‹°ê¸°', text: 'ì—ë“œë ¤ ìì„¸ ë²„í‹°ê¸°' }, { id: 'act_slide_var', label: 'ê²½ì‚¬ë©´ ë‚´ë ¤ì˜¤ê¸°', text: 'ê²½ì‚¬ë©´ ë‚´ë ¤ì˜¤ê¸°' },
                        { id: 'act_heavy_walk', label: 'ì† ì§šê³  ë„¤ë°œ ê±·ê¸°', text: 'ì† ì§šê³  ë„¤ë°œ ê±·ê¸°' }, { id: 'act_incline_crawl', label: 'ê²½ì‚¬ë©´ ê¸°ì–´ ì˜¤ë¥´ê¸°', text: 'ê²½ì‚¬ë©´ ê¸°ì–´ ì˜¤ë¥´ê¸°' },
                        { id: 'act_scooter_propel', label: 'ì—ë“œë ¤ ë³´ë“œ íƒ€ê¸°', text: 'ì—ë“œë ¤ ë³´ë“œ íƒ€ê¸°' }, { id: 'act_narrow_walk', label: 'ì¢ì€ ê¸¸ ê±·ê¸°', text: 'ì¢ì€ ê¸¸ ê±·ê¸°' },
                        { id: 'act_dynamic_bal', label: 'í”ë“¤ë¦¬ëŠ” íŒ ì„œê¸°', text: 'í”ë“¤ë¦¬ëŠ” íŒ ìœ„ì—ì„œ ì„œê¸°' }, { id: 'act_one_leg', label: 'í•œ ë°œë¡œ ì¤‘ì‹¬ ì¡ê¸°', text: 'í•œ ë°œë¡œ ì¤‘ì‹¬ ì¡ê¸°' },
                        { id: 'act_jump_obs', label: 'ê¹œì§ ì¥ì• ë¬¼ ë„˜ê¸°', text: 'ê¹œì§ íŠ€ì–´ ì¥ì• ë¬¼ ë„˜ê¸°' }, { id: 'act_jump_rhythm', label: 'ë¦¬ë“¬ ë§ì¶° ì í”„í•˜ê¸°', text: 'ë¦¬ë“¬ ë§ì¶° ì í”„í•˜ê¸°' },
                        { id: 'act_rope_jump', label: 'ì¤„/í›„í”„ ë›°ì–´ ë„˜ê¸°', text: 'ì¤„/í›„í”„ ë›°ì–´ ë„˜ê¸°' }, { id: 'act_count_jump', label: 'ìˆ«ì ì„¸ë©° ê¹œì§', text: 'ìˆ«ì ì„¸ë©° ê¹œì§ ë›°ì–´ì˜¤ë¥´ê¸°' },
                        { id: 'act_visual_hunt', label: 'ì´ë™í•˜ë©° ë¬¼ì²´ ì°¾ê¸°', text: 'ì´ë™í•˜ë©° ë¬¼ì²´ ì°¾ê¸°' }, { id: 'act_fetch_relay', label: 'ë¬¼ê±´ ê°€ì ¸ì˜¤ê¸°(ì™•ë³µ)', text: 'ë¬¼ê±´ ê°€ì ¸ì˜¤ê¸°(ì™•ë³µ)' },
                        { id: 'act_path_posture', label: 'ê¸¸ ë”°ë¼ ìì„¸ ë°”ê¾¸ê¸°', text: 'ê¸¸ ë”°ë¼ ìì„¸ ë°”ê¿” ê°€ê¸°' }, { id: 'act_target_throw', label: 'ëª©í‘œë¬¼ ë§ì¶”ê¸°', text: 'ëª©í‘œë¬¼ ë§ì¶”ê¸°/êµ´ë¦¬ê¸°' },
                        { id: 'act_eye_hand', label: 'ê³µ íŠ€ê¸°ê³  ì¡ê¸°', text: 'ê³µ íŠ€ê¸°ê³  ì¡ê¸°' }, { id: 'act_body_roll', label: 'ì‹ ì²´ íšŒì „í•˜ê¸°', text: 'ì‹ ì²´ íšŒì „í•˜ê¸°' },
                        { id: 'act_bilateral', label: 'ì–‘ì† í˜‘ì‘ ë™ì‘í•˜ê¸°', text: 'ì–‘ì† í˜‘ì‘ ë™ì‘í•˜ê¸°' }
                    ]}
                ]
            },
            D: {
                sections: [
                    { id: 'D1', items: [
                        { id: 'e1_seek_high', label: 'ê°ê° ì¶”êµ¬ (ê³ ë„)', text: 'íŠ¹ì • ê°ê°ì— ëŒ€í•œ ê³ ë„í•œ ì¶”êµ¬ ë°˜ì‘ ê´€ì°°' },
                        { id: 'e1_avoid_high', label: 'ê°ê° íšŒí”¼ (ì‹¬í•¨)', text: 'íŠ¹ì • ê°ê° ìê·¹ì— ëŒ€í•´ ì‹¬í•œ íšŒí”¼ ë°˜ì‘ ë³´ì„' },
                        { id: 'e1_seek_mod', label: 'ê°ê° ì¡°ì ˆ ì ì ˆ', text: 'ì œê³µëœ ê°ê° ì…ë ¥ì— ëŒ€í•´ ì ì ˆí•œ ì¡°ì ˆ ë°˜ì‘ ìœ ì§€' },
                    ]},
                    { id: 'D2', items: [
                        { id: 'e2_imit_good', label: 'ë™ì‘ ëª¨ë°© (ìƒ)', text: 'ì¹˜ë£Œì‚¬ì˜ ë™ì‘ì„ ì •í™•í•˜ê³  ì¦‰ê°ì ìœ¼ë¡œ ëª¨ë°©í•¨' },
                        { id: 'e2_imit_poor', label: 'ë™ì‘ ëª¨ë°© (í•˜)', text: 'ë™ì‘ ëª¨ë°© ì‹œ ì‹œê°ì  ë‹¨ì„œì™€ ì‹ ì²´ì  ì´‰ì§„ì´ í•„ìš”í–ˆìŒ' },
                        { id: 'e2_posture_indep', label: 'ìì„¸ ìœ ì§€ (ë…ë¦½)', text: 'ë„êµ¬ ìœ„ì—ì„œ í”ë“¤ë¦¼ì„ ê²¬ë””ë©° ë…ë¦½ì ìœ¼ë¡œ ìì„¸ ìœ ì§€' },
                        { id: 'e2_posture_assist', label: 'ìì„¸ ìœ ì§€ (ë³´ì¡°)', text: 'ìì„¸ ì¡°ì ˆ ëŠ¥ë ¥ì´ ë¶€ì¡±í•˜ì—¬ ì‹ ì²´ì  ì§€ì§€ ì œê³µí•¨' },
                        { id: 'e6_perf_high', label: 'ìˆ˜í–‰ë„ 80%â†‘', text: 'ê³¼ì œ ìˆ˜í–‰ ì™„ì„±ë„ê°€ 80% ì´ìƒìœ¼ë¡œ ë†’ìŒ' },
                        { id: 'e6_perf_mid', label: 'ìˆ˜í–‰ë„ 50-79%', text: 'í˜„ì¬ ë‚œì´ë„ì—ì„œ 50~79% ìˆ˜ì¤€ì˜ ìˆ˜í–‰ë ¥ ë³´ì„' },
                        { id: 'e6_perf_low', label: 'ìˆ˜í–‰ë„ 50%â†“', text: 'ê³¼ì œ ìˆ˜í–‰ë„ê°€ 50% ë¯¸ë§Œìœ¼ë¡œ ë‚˜íƒ€ë‚¨' },
                        { id: 'e6_perf_improve', label: 'ì ì§„ì  í–¥ìƒ', text: 'ì´ˆë°˜ ì–´ë ¤ì›€ ìˆì—ˆìœ¼ë‚˜ ì¤‘ë°˜ ì´í›„ ì ì ˆí•œ ìˆ˜í–‰ ë³´ì„' },
                    ]},
                    { id: 'D3', items: [
                        { id: 'e3_att_good', label: 'ê³¼ì œ ì§‘ì¤‘ (ì§€ì†)', text: 'ì œì‹œëœ ê³¼ì œì— ëŒ€í•´ ëê¹Œì§€ ì£¼ì˜ë¥¼ ì§€ì†í•˜ë©° ì™„ìˆ˜í•¨' },
                        { id: 'e3_att_dist', label: 'ê³¼ì œ ì§‘ì¤‘ (ì‚°ë§Œ)', text: 'ì£¼ì˜ê°€ ì‰½ê²Œ ì‚°ë§Œí•´ì ¸ ì¦ì€ í™˜ê¸°ì™€ í™˜ê²½ ì¡°ì ˆ í•„ìš”' },
                        { id: 'e3_trans_good', label: 'ì „í™˜ ë°˜ì‘ (ì›í™œ)', text: 'í™œë™ ì „í™˜ì´ ì›í™œí•˜ê²Œ ì´ë£¨ì–´ì§' },
                        { id: 'e3_trans_resist', label: 'ì „í™˜ ë°˜ì‘ (ì €í•­)', text: 'í™œë™ ì „í™˜ ì‹œ ì €í•­ì„ ë³´ì„' },
                    ]},
                    { id: 'D4', items: [
                        { id: 'e4_emo_joy', label: 'í™œë™ ì •ì„œ (ì¦ê±°ì›€)', text: 'ê¸ì •ì ì¸ ì •ì„œë¥¼ í‘œì¶œí•˜ë©° ì¦ê²ê²Œ ì°¸ì—¬í•¨' },
                        { id: 'e4_emo_anx', label: 'í™œë™ ì •ì„œ (ë¶ˆì•ˆ)', text: 'ìµìˆ™í•˜ì§€ ì•Šì€ í™œë™ì— ë¶ˆì•ˆê°ì„ í‘œí˜„í•¨' },
                        { id: 'e4_fail_giveup', label: 'ì‹¤íŒ¨ ëŒ€ì²˜ (í¬ê¸°)', text: 'ê³¼ì œ ì‹¤íŒ¨ ì‹œ ì‰½ê²Œ í¬ê¸°í•˜ëŠ” ëª¨ìŠµ ë³´ì„' },
                    ]},
                    { id: 'D5', items: [
                        { id: 'e5_eye_freq', label: 'ì‹œì„  ë§ì¶¤ (ë¹ˆë²ˆ)', text: 'ì¹˜ë£Œì‚¬ì™€ ë¹ˆë²ˆí•˜ê²Œ ì‹œì„ ì„ ë§ì¶”ë©° ìƒí˜¸ì‘ìš©í•¨' },
                        { id: 'e5_eye_avoid', label: 'ì‹œì„  ë§ì¶¤ (íšŒí”¼)', text: 'ìƒí˜¸ì‘ìš© ì‹œ ì‹œì„ ì„ íšŒí”¼í•¨' },
                        { id: 'e5_interact_spon', label: 'ìƒí˜¸ì‘ìš© (ìë°œì )', text: 'ìë°œì ìœ¼ë¡œ ìƒí˜¸ì‘ìš©ì„ ì‹œë„í•¨' },
                        { id: 'e5_order_imm', label: 'ì§€ì‹œ ë”°ë¥´ê¸° (ì¦‰ê°)', text: 'ì§€ì‹œë¥¼ ì¦‰ê°ì ìœ¼ë¡œ ìˆ˜í–‰í•¨' },
                    ]}
                ]
            },
            E: {
                sections: [
                    { id: 'E1', items: [
                        { id: 'f1_input_inc', label: 'ì…ë ¥ê°•ë„ (ì¦ê°€)', text: 'ê°ì„± ìˆ˜ì¤€ì„ ë†’ì´ê¸° ìœ„í•´ ì…ë ¥ ê°•ë„ ìƒí–¥' },
                        { id: 'f1_input_dec', label: 'ì…ë ¥ê°•ë„ (ê°ì†Œ)', text: 'ê³¼ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•´ ì…ë ¥ ê°•ë„ í•˜í–¥' },
                        { id: 'f1_speed_fast', label: 'í™œë™ì†ë„ (ë¹ ë¥´ê²Œ)', text: 'ì—­ë™ì  ì›€ì§ì„ì„ ìœ„í•´ ì†ë„ ë¹ ë¥´ê²Œ ì§„í–‰' },
                        { id: 'f1_speed_slow', label: 'í™œë™ì†ë„ (ì²œì²œíˆ)', text: 'ì •í™•í•œ ê³„íšì„ ìœ„í•´ ì†ë„ ì²œì²œíˆ ì¡°ì ˆ' },
                        { id: 'f1_rest_freq', label: 'íœ´ì‹ì œê³µ (ë¹ˆë²ˆ)', text: 'ë¹ˆë²ˆí•œ íœ´ì‹ ì œê³µ' },
                    ]},
                    { id: 'E2', items: [
                        { id: 'f2_phys_guide', label: 'ì‹ ì²´ ê°€ì´ë“œ ì œê³µ', text: 'ì‹ ì²´ì  ê°€ì´ë“œ ì œê³µ' },
                        { id: 'f2_verbal_enc', label: 'ì–¸ì–´ì  ê²©ë ¤', text: 'ì–¸ì–´ì  í”¼ë“œë°±ê³¼ ê²©ë ¤ ì œê³µ' },
                        { id: 'f2_visual_sch', label: 'ì‹œê° ìŠ¤ì¼€ì¤„', text: 'ì‹œê°ì  ìŠ¤ì¼€ì¤„ ì œì‹œ' },
                        { id: 'f2_timer', label: 'íƒ€ì´ë¨¸ í™œìš©', text: 'ì‹œê° íƒ€ì´ë¨¸ í™œìš©' },
                    ]},
                    { id: 'E3', items: [
                        { id: 'f3_reward_imm', label: 'ê¸ì •ê°•í™” (ì¦‰ê°)', text: 'ì¦‰ê°ì ì¸ ë³´ìƒ ì œê³µ' },
                        { id: 'f3_reward_delay', label: 'ê¸ì •ê°•í™” (ì§€ì—°)', text: 'ì§€ì—°ëœ ê°•í™” ì œê³µ' },
                        { id: 'f3_alt_beh', label: 'ëŒ€ì•ˆ í–‰ë™ ì œì‹œ', text: 'ëŒ€ì•ˆ í–‰ë™ ëª¨ë¸ë§' },
                        { id: 'f3_sen_break', label: 'ê°ê° ì¡°ì ˆ íœ´ì‹', text: 'ê°ê° ì¡°ì ˆ íœ´ì‹ ì œê³µ' },
                    ]},
                    { id: 'E4', items: [
                        { id: 'f4_proprio', label: 'ì•ˆì •í™” ì…ë ¥', text: 'ê³ ìœ ìˆ˜ìš©ì„± ì…ë ¥ ì œê³µ' },
                        { id: 'f4_choice', label: 'ì„ íƒ ì œê³µ', text: 'ì„ íƒ ê¸°íšŒ ì œê³µ' },
                        { id: 'f4_step', label: 'ë‹¨ê³„ì  ì œì‹œ', text: 'ê³¼ì œ ë‹¨ê³„ì  ì œì‹œ' },
                        { id: 'f4_repeat', label: 'ë°˜ë³µ ì—°ìŠµ', text: 'ë°˜ë³µ ì—°ìŠµ ìœ ë„' },
                    ]}
                ]
            }
        };

        let state = {
            basicInfo: { name: '', dob: '', date: new Date().toISOString().split('T')[0] },
            checkedItems: {},
            history: []
        };

        document.addEventListener('DOMContentLoaded', () => {
            initDiagnosisDropdown();
            renderGrid();
            loadHistory();
            loadDraft();
            generateReport();
        });

        function renderGrid() {
            const containerB = document.getElementById('container-B');
            CATEGORIES.B.items.forEach(item => containerB.appendChild(createCheckbox(item)));
            ['C', 'D', 'E'].forEach(cat => {
                CATEGORIES[cat].sections.forEach(sec => {
                    renderItemsToContainer(cat, sec.id, `container-${sec.id}`);
                });
            });
        }

        function renderItemsToContainer(catKey, secId, containerId) {
            const section = CATEGORIES[catKey].sections.find(s => s.id === secId);
            const container = document.getElementById(containerId);
            if (section && container) {
                section.items.forEach(item => container.appendChild(createCheckbox(item)));
            }
        }

        function createCheckbox(item) {
            const label = document.createElement('label');
            label.className = 'checkbox-wrapper';
            label.id = `label-${item.id}`;
            label.innerHTML = `<input type="checkbox" id="chk-${item.id}" onchange="toggleCheck('${item.id}')"><span>${item.label}</span>`;
            return label;
        }

        function toggleCheck(id) {
            const chk = document.getElementById(`chk-${id}`);
            const lbl = document.getElementById(`label-${id}`);
            state.checkedItems[id] = chk.checked;
            chk.checked ? lbl.classList.add('checked') : lbl.classList.remove('checked');
            saveDraft();
            generateReport();
        }

        function handleNameInput() {
            const name = document.getElementById('input-name').value.trim();
            state.basicInfo.name = name;
            const found = state.history.find(h => h.name === name && h.dob);
            if (found && !document.getElementById('input-dob').value) {
                document.getElementById('input-dob').value = found.dob;
                if(found.diagnosis) {
                    const sel = document.getElementById('select-diagnosis');
                    sel.value = [...sel.options].some(o => o.value === found.diagnosis) ? found.diagnosis : 'manual';
                    if(sel.value === 'manual') {
                        document.getElementById('input-diagnosis-manual').classList.remove('hidden');
                        document.getElementById('input-diagnosis-manual').value = found.diagnosis;
                    }
                    handleDiagnosisSelect();
                }
            }
            updateBasicInfo();
        }

        function updateBasicInfo() {
            state.basicInfo.name = document.getElementById('input-name').value;
            state.basicInfo.dob = document.getElementById('input-dob').value;
            state.basicInfo.date = document.getElementById('input-date').value;
            
            if(state.basicInfo.dob && state.basicInfo.date) {
                const birth = new Date(state.basicInfo.dob);
                const target = new Date(state.basicInfo.date);
                let m = (target.getFullYear() - birth.getFullYear()) * 12 + (target.getMonth() - birth.getMonth());
                if (target.getDate() < birth.getDate()) m--;
                document.getElementById('display-age').innerText = m < 0 ? 'ë¯¸ë˜' : `${Math.floor(m/12)}ì„¸ ${m%12}ê°œì›”`;
                state.basicInfo.ageString = document.getElementById('display-age').innerText;
            }

            if(state.basicInfo.name && state.basicInfo.date) {
                const d = new Date(state.basicInfo.date);
                const sessions = state.history.filter(h => {
                    const hd = new Date(h.date);
                    return h.name === state.basicInfo.name && hd.getMonth() === d.getMonth() && hd.getFullYear() === d.getFullYear();
                });
                const badge = document.getElementById('session-count-badge');
                badge.innerText = `${d.getMonth()+1}ì›” ${sessions.length + 1}íšŒì°¨`;
                badge.classList.remove('hidden');
            }
            
            saveDraft();
            generateReport();
        }

        function resetDob() {
            document.getElementById('input-dob').value = "";
            state.basicInfo.dob = "";
            document.getElementById('display-age').innerText = "-";
            updateBasicInfo();
        }

        function initDiagnosisDropdown() {
            const sel = document.getElementById('select-diagnosis');
            DIAGNOSIS_LIST.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.value; opt.text = d.label;
                sel.appendChild(opt);
            });
        }

        function handleDiagnosisSelect() {
            const val = document.getElementById('select-diagnosis').value;
            const tip = document.getElementById('diagnosis-tip');
            const manual = document.getElementById('input-diagnosis-manual');
            
            if(val === "") {
                tip.classList.add('hidden');
                manual.classList.add('hidden');
                state.basicInfo.diagnosis = "";
            } else {
                const data = DIAGNOSIS_LIST.find(d => d.value === val);
                if(data) {
                    tip.textContent = "Tip: " + data.keywords;
                    tip.classList.remove('hidden');
                    manual.classList.add('hidden');
                    state.basicInfo.diagnosis = data.value;
                }
            }
            updateBasicInfo();
        }

        function generateReport() {
            const goals = CATEGORIES.B.items.filter(i => state.checkedItems[i.id]).map(i => i.label);
            const tools = [];
            ['C1','C2','C3','C4'].forEach(id => {
                const sec = CATEGORIES.C.sections.find(s => s.id === id);
                tools.push(...sec.items.filter(i => state.checkedItems[i.id]).map(i => i.label));
            });
            const activities = CATEGORIES.C.sections.find(s => s.id === 'C5').items.filter(i => state.checkedItems[i.id]).map(i => i.text);
            const responses = [];
            CATEGORIES.D.sections.forEach(s => responses.push(...s.items.filter(i => state.checkedItems[i.id]).map(i => i.text)));
            const interventions = [];
            CATEGORIES.E.sections.forEach(s => interventions.push(...s.items.filter(i => state.checkedItems[i.id]).map(i => i.text)));

            const condition = document.getElementById('input-condition').value;
            const memo = document.getElementById('input-memo').value;

            let t = `[ì¹˜ë£Œ ì¼ì§€]\nì•„ë™ëª…: ${state.basicInfo.name} (${state.basicInfo.ageString || '-'}) | ë‚ ì§œ: ${state.basicInfo.date}\n`;
            if(document.getElementById('session-count-badge').innerText) t += `íšŒì°¨: ${document.getElementById('session-count-badge').innerText}\n`;
            t += `ì§„ë‹¨: ${state.basicInfo.diagnosis || '-'}\n\n`;

            t += `1. ì¹˜ë£Œ ëª©í‘œ\n${goals.length ? goals.join(', ') + 'ì„(ë¥¼) ëª©í‘œë¡œ í•¨.' : '(ì„ íƒ ì—†ìŒ)'}\n\n`;
            
            t += `2. í™œë™ ë‚´ìš©\n`;
            if(activities.length) {
                if(tools.length) t += `${tools.join(', ')} ë“±ì„ í™œìš©í•˜ì—¬, `;
                t += `ë‹¤ìŒ í™œë™ì„ ì§„í–‰í•¨.\n- ${activities.join('\n- ')}\n\n`;
            } else t += `(ì„ íƒ ì—†ìŒ)\n\n`;

            t += `3. ì•„ë™ ë°˜ì‘ ë° ì¤‘ì¬\n`;
            const obs = [];
            if(condition) obs.push(`ì»¨ë””ì…˜: ${condition}`);
            obs.push(...responses, ...interventions);
            if(memo) obs.push(`íŠ¹ì´ì‚¬í•­: ${memo}`);
            t += obs.length ? `- ${obs.join('\n- ')}\n\n` : `(íŠ¹ì´ì‚¬í•­ ì—†ìŒ)\n\n`;

            t += `4. ì¢…í•© í‰ê°€\n`;
            if(responses.some(r => r.includes('ê³¼ë„') || r.includes('íšŒí”¼') || r.includes('ì‚°ë§Œ'))) {
                t += `ê°ê° ì¡°ì ˆ ë° ì£¼ì˜ ì§‘ì¤‘ ì§€ì›ì´ í•„ìš”í•˜ì˜€ìœ¼ë‚˜, ì ì ˆí•œ ì¤‘ì¬ë¡œ ê³¼ì œë¥¼ ìˆ˜í–‰í•¨.`;
            } else {
                t += `ì•ˆì •ì ì¸ ê°ì„± ìˆ˜ì¤€ì„ ìœ ì§€í•˜ë©° ê³¼ì œì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•¨.`;
            }

            document.getElementById('report-output').value = t;
        }

        // â­ Netlify Functionìœ¼ë¡œ AI í˜¸ì¶œ (API í‚¤ ìˆ¨ê¹€)
        async function generateGeminiSummary() {
            const reportText = document.getElementById('report-output').value;
            
            if (!reportText.trim() || reportText.length < 50) {
                alert("ë¶„ì„í•  ì¼ì§€ ë‚´ìš©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const btn = document.getElementById('btn-ai');
            const loading = document.getElementById('ai-loading');
            const output = document.getElementById('ai-output');
            const selectedMode = document.querySelector('input[name="ai-mode"]:checked').value;

            btn.disabled = true;
            loading.classList.remove('hidden');
            output.value = "";

            try {
                // â­ Netlify Function í˜¸ì¶œ (/.netlify/functions/gemini)
                const response = await fetch('/.netlify/functions/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reportText: reportText,
                        mode: selectedMode
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

                output.value = data.summary;

            } catch (error) {
                console.error(error);
                output.value = `[ì˜¤ë¥˜ ë°œìƒ] ${error.message}`;
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        }

        function saveLog() {
            if(!state.basicInfo.name) return alert("ì´ë¦„ ì…ë ¥ í•„ìš”");
            const entry = {
                id: Date.now(),
                date: state.basicInfo.date,
                name: state.basicInfo.name,
                dob: state.basicInfo.dob,
                diagnosis: state.basicInfo.diagnosis,
                report: document.getElementById('report-output').value,
                checkedItems: {...state.checkedItems}
            };
            state.history.unshift(entry);
            saveHistoryToLocal();
            renderHistory();
            resetApp();
        }

        function deleteLog(id) {
            if(confirm("ì •ë§ë¡œ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                state.history = state.history.filter(h => h.id !== id);
                saveHistoryToLocal();
                renderHistory();
            }
        }

        function saveHistoryToLocal() {
            localStorage.setItem('si_log_history_full', JSON.stringify(state.history));
        }

        function resetApp() {
            localStorage.removeItem('si_log_draft_full');
            location.reload();
        }

        function saveDraft() {
            localStorage.setItem('si_log_draft_full', JSON.stringify({basicInfo: state.basicInfo, checkedItems: state.checkedItems}));
        }

        function loadDraft() {
            const s = localStorage.getItem('si_log_draft_full');
            if(s) {
                const d = JSON.parse(s);
                state.basicInfo = d.basicInfo || state.basicInfo;
                state.checkedItems = d.checkedItems || {};
                document.getElementById('input-name').value = state.basicInfo.name;
                document.getElementById('input-dob').value = state.basicInfo.dob;
                document.getElementById('input-date').value = state.basicInfo.date;
                for(const id in state.checkedItems) {
                    if(state.checkedItems[id]) {
                        const el = document.getElementById(`chk-${id}`);
                        if(el) { el.checked = true; document.getElementById(`label-${id}`).classList.add('checked'); }
                    }
                }
                updateBasicInfo();
            }
        }

        function loadHistory() {
            const s = localStorage.getItem('si_log_history_full');
            if(s) { state.history = JSON.parse(s); }
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const empty = document.getElementById('empty-history');
            list.innerHTML = '';
            
            if (state.history.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            state.history.forEach(h => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded shadow border border-slate-300 relative group transition hover:shadow-md';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-bold text-lg text-slate-800">${h.name}</span>
                            <span class="text-sm text-slate-500 ml-2">${h.date}</span>
                        </div>
                        <button onclick="deleteLog(${h.id})" class="text-red-400 hover:text-red-600 border border-red-200 hover:bg-red-50 rounded px-2 py-1 text-xs transition">
                            ì‚­ì œ ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="text-xs text-slate-600 whitespace-pre-wrap leading-relaxed bg-slate-50 p-2 rounded">${h.report}</div>
                `;
                list.appendChild(div);
            });
        }

        function exportData() {
            if(!state.history.length) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            let csv = "\uFEFFì´ë¦„,ë‚ ì§œ,ë‚´ìš©\n";
            state.history.forEach(h => {
                csv += `"${h.name}","${h.date}","${h.report.replace(/"/g, '""')}"\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `treatment_logs_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function switchTab(t) {
            document.getElementById('tab-write').classList.toggle('hidden', t !== 'write');
            document.getElementById('tab-history').classList.toggle('hidden', t !== 'history');
            
            const btnWrite = document.getElementById('btn-tab-write');
            const btnHistory = document.getElementById('btn-tab-history');
            
            if(t === 'write') {
                btnWrite.className = "px-3 py-1 rounded bg-blue-600 text-xs font-bold text-white";
                btnHistory.className = "px-3 py-1 rounded bg-slate-600 text-xs text-slate-200 font-bold hover:bg-slate-500";
            } else {
                btnWrite.className = "px-3 py-1 rounded bg-slate-600 text-xs text-slate-200 font-bold hover:bg-slate-500";
                btnHistory.className = "px-3 py-1 rounded bg-blue-600 text-xs font-bold text-white";
            }
        }

        function copyReport() {
            navigator.clipboard.writeText(document.getElementById('report-output').value);
            alert("ì¼ì§€ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function sendToGoogleDocs() {
            copyReport();
            if(confirm("ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ê¸€ ë¬¸ì„œ ìƒˆ ì°½ì„ ì—¬ì‹œê² ìŠµë‹ˆê¹Œ?")) window.open('https://docs.google.com/document/create', '_blank');
        }
    </script>
</body>
</html>